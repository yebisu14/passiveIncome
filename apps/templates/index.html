<!DOCTYPE html>
<html lang="jp">

  <head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Thumbnail Gallery - Start Bootstrap Template</title>

    <!-- Bootstrap core CSS -->
    <link href="static/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="static/css/thumbnail-gallery.css" rel="stylesheet">

    <link href="static/css/common.css" rel="stylesheet">

  </head>

  <body>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
      <div class="container">
        <a class="navbar-brand" href="#">動画共有サービス</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav ml-auto">
              <li class="nav-item">
                  <a class="nav-link" href="/mypage">
                    マイページ
                  </a>
              </li>
            <li class="nav-item">
                <a class="nav-link" href="/histories">
                  購入履歴
                </a>
            </li>
            <li class="nav-item active">
              <a class="nav-link" href="#">
                <div>
                    Balance:&nbsp;<span id="balance">0</span>&nbsp;ETH
                </div>
                <span class="sr-only">(current)</span>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Page Content -->
    <div class="container" style="margin-top: 24px; margin-bottom: 24px;">


        <div class="row">

          <!-- 東京タワーを見る動画 -->
          <div class="col-lg-3 col-md-4 col-xs-6 wrapper-thumbnail wrapper-a">
            <span class="label-live">LIVE</span>
            <img class="thumbnail" src="static/img/thumbnails/20180911_155441.jpg" alt="">
            <p class="label-title">東京タワーを見る動画</p>
            <a href="#" id="a_tag"></a>
          </div>


          <!-- 猫を見る動画 -->
          <div class="col-lg-3 col-md-4 col-xs-6 wrapper-thumbnail">
            <span class="label-live">LIVE</span>
            <img class="thumbnail" src="static/img/thumbnails/20180911_155441.jpg" alt="">
            <p class="label-title">猫を見る動画</p>
          </div>
  

        </div>


    </div>
    <!-- /.container -->

    <!-- Footer -->
    <footer class="py-5 bg-dark">
      <div class="container">
        <p class="m-0 text-center text-white">Copyright &copy; Passive Income 2018</p>
      </div>
      <!-- /.container -->
    </footer>

    <!-- Bootstrap core JavaScript -->
    <script src="static/vendor/jquery/jquery.min.js"></script>
    <script src="static/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="static/js/uuid.js"></script>
    <!--<script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>-->
    <script src="static/js/app.js"></script>

    <script>
      $(()=>{
        // 現在の残高を表示する
        var myAddress = web3.eth.defaultAccount;
        web3.eth.getBalance(myAddress, function(err, balance){
          $('#balance').html(balance.c[0]/10000);
        });

        //  uuid保存
        function saveUuid(to, u4){
          var reciepts = JSON.parse(localStorage.getItem("reciepts")) || [];
          reciepts.push({
            uuid: u4,
            addr: to
          });
          localStorage.setItem("reciepts", JSON.stringify(reciepts));
        }

        //  購入処理を走らせる
        //  現状いいコールバックが見当たらないので、こんな実装にしてしまった
        $('#a_tag').on('click', ()=>{
          var u4 = uuid4();
          var to = '0x8de894ec4a1102e43cc33039d28de0b011bd2d5a'
          buyMovieOnContract(to, u4, 
            result=>{
              saveUuid(to, u4);
              console.log("saved");
              alert("購入成功");
            }, 
            err=>console.log);
        });


      });
    </script>

  </body>

</html>